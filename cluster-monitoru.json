{
  "__requires": [
    {
      "type": "grafana",
      "id": "grafana",
      "name": "Grafana",
      "version": "10.0.0"
    },
    {
      "type": "panel",
      "id": "row",
      "name": "Row",
      "version": ""
    },
    {
      "type": "panel",
      "id": "stat",
      "name": "Stat",
      "version": ""
    },
    {
      "type": "panel",
      "id": "table",
      "name": "Table",
      "version": ""
    },
    {
      "type": "panel",
      "id": "timeseries",
      "name": "Time series",
      "version": ""
    },
    {
      "type": "panel",
      "id": "bargauge",
      "name": "Bar gauge",
      "version": ""
    },
    {
      "type": "datasource",
      "id": "prometheus",
      "name": "Prometheus",
      "version": "2.0.0"
    },
    {
      "type": "panel",
      "id": "text",
      "name": "Text",
      "version": ""
    }
  ],
  "dashboard": {
    "id": null,
    "uid": null,
    "title": "Cluster Namespace Overview - <ClusterName>",
    "schemaVersion": 39,
    "version": 1,
    "refresh": "30s",
    "time": {
      "from": "now-6h",
      "to": "now"
    },
    "templating": {
      "list": [
        {
          "name": "DS",
          "label": "Prometheus",
          "type": "datasource",
          "query": "prometheus",
          "hide": 0
        },
        {
          "name": "cluster",
          "label": "Cluster",
          "type": "constant",
          "query": "<ClusterName>",
          "current": {
            "text": "<ClusterName>",
            "value": "<ClusterName>"
          },
          "hide": 0,
          "description": "Set this to the cluster name (pure label for titles/links)"
        },
        {
          "name": "namespace",
          "label": "Namespace",
          "type": "query",
          "datasource": "${DS}",
          "refresh": 2,
          "includeAll": true,
          "multi": true,
          "allValue": ".*",
          "sort": 1,
          "query": "label_values(kube_pod_info, namespace)",
          "definition": "label_values(kube_pod_info, namespace)",
          "hide": 0
        }
      ]
    },
    "links": [
      {
        "asDropdown": true,
        "icon": "dashboard",
        "includeVars": true,
        "tags": [],
        "targetBlank": false,
        "title": "Go to Namespace Service Details",
        "type": "link",
        "url": "/d/ns-service-details/namespace-service-details?var-cluster=${DS}&var-namespace=$namespace"
      }
    ],
    "panels": [
      {
        "type": "row",
        "title": "Overview",
        "gridPos": {
          "h": 1,
          "w": 24,
          "x": 0,
          "y": 0
        },
        "collapsed": false,
        "panels": []
      },
      {
        "type": "table",
        "title": "Namespaces \u2013 Status (Running / Pending / Terminating)",
        "gridPos": {
          "h": 10,
          "w": 24,
          "x": 0,
          "y": 1
        },
        "datasource": "${DS}",
        "options": {
          "showHeader": true
        },
        "targets": [
          {
            "refId": "RUN",
            "expr": "sum by (namespace) (kube_pod_status_phase{phase=\"Running\", namespace=~\"$namespace\"})",
            "instant": true,
            "legendFormat": "{{namespace}}"
          },
          {
            "refId": "PEND",
            "expr": "sum by (namespace) (kube_pod_status_phase{phase=\"Pending\", namespace=~\"$namespace\"})",
            "instant": true
          },
          {
            "refId": "TERM",
            "expr": "sum by (namespace) (max by (namespace,pod) (kube_pod_deletion_timestamp{namespace=~\"$namespace\"} > 0))",
            "instant": true
          }
        ],
        "fieldConfig": {
          "defaults": {
            "links": [
              {
                "title": "Drill to Namespace Service Details",
                "url": "/d/ns-service-details/namespace-service-details?var-cluster=${DS}&var-namespace=${__field.labels.namespace}"
              }
            ]
          },
          "overrides": []
        }
      },
      {
        "type": "row",
        "title": "Resources",
        "gridPos": {
          "h": 1,
          "w": 24,
          "x": 0,
          "y": 11
        },
        "collapsed": true,
        "panels": []
      },
      {
        "type": "table",
        "title": "CPU per Namespace (cores) \u2013 avg pod / max pod",
        "gridPos": {
          "h": 8,
          "w": 12,
          "x": 0,
          "y": 12
        },
        "datasource": "${DS}",
        "options": {
          "showHeader": true
        },
        "targets": [
          {
            "refId": "AVG",
            "expr": "avg by (namespace) (sum by (namespace,pod) (rate(container_cpu_usage_seconds_total{image!=\"\"}[$__rate_interval])))",
            "instant": true
          },
          {
            "refId": "MAX",
            "expr": "max by (namespace) (sum by (namespace,pod) (rate(container_cpu_usage_seconds_total{image!=\"\"}[$__rate_interval])))",
            "instant": true
          }
        ]
      },
      {
        "type": "table",
        "title": "Memory per Namespace (GiB) \u2013 avg pod / max pod",
        "gridPos": {
          "h": 8,
          "w": 12,
          "x": 12,
          "y": 12
        },
        "datasource": "${DS}",
        "options": {
          "showHeader": true
        },
        "targets": [
          {
            "refId": "AVG",
            "expr": "avg by (namespace) (sum by (namespace,pod) (container_memory_working_set_bytes{container!=\"\"})) / 1024^3",
            "instant": true
          },
          {
            "refId": "MAX",
            "expr": "max by (namespace) (sum by (namespace,pod) (container_memory_working_set_bytes{container!=\"\"})) / 1024^3",
            "instant": true
          }
        ]
      },
      {
        "type": "stat",
        "title": "Pods (Running)",
        "gridPos": {
          "h": 4,
          "w": 6,
          "x": 0,
          "y": 20
        },
        "datasource": "${DS}",
        "targets": [
          {
            "refId": "A",
            "expr": "sum(kube_pod_status_phase{phase=\"Running\", namespace=~\"$namespace\"})",
            "instant": true
          }
        ]
      },
      {
        "type": "stat",
        "title": "Pods (Pending)",
        "gridPos": {
          "h": 4,
          "w": 6,
          "x": 6,
          "y": 20
        },
        "datasource": "${DS}",
        "targets": [
          {
            "refId": "A",
            "expr": "sum(kube_pod_status_phase{phase=\"Pending\", namespace=~\"$namespace\"})",
            "instant": true
          }
        ]
      },
      {
        "type": "stat",
        "title": "Services (Active)",
        "gridPos": {
          "h": 4,
          "w": 6,
          "x": 12,
          "y": 20
        },
        "datasource": "${DS}",
        "targets": [
          {
            "refId": "A",
            "expr": "count(count by (namespace,service) (kube_service_info{namespace=~\"$namespace\"}))",
            "instant": true
          }
        ]
      },
      {
        "type": "stat",
        "title": "Deployments",
        "gridPos": {
          "h": 4,
          "w": 6,
          "x": 18,
          "y": 20
        },
        "datasource": "${DS}",
        "targets": [
          {
            "refId": "A",
            "expr": "count(count by (namespace,deployment) (kube_deployment_labels{namespace=~\"$namespace\"}))",
            "instant": true
          }
        ]
      },
      {
        "type": "table",
        "title": "Resource Quotas vs Used (per Namespace)",
        "gridPos": {
          "h": 8,
          "w": 24,
          "x": 0,
          "y": 24
        },
        "datasource": "${DS}",
        "options": {
          "showHeader": true
        },
        "targets": [
          {
            "refId": "pods_used",
            "expr": "sum by (namespace) (kube_resourcequota{resource=\"pods\", type=\"used\", namespace=~\"$namespace\"})",
            "instant": true
          },
          {
            "refId": "pods_hard",
            "expr": "sum by (namespace) (kube_resourcequota{resource=\"pods\", type=\"hard\", namespace=~\"$namespace\"})",
            "instant": true
          },
          {
            "refId": "cpu_used",
            "expr": "sum by (namespace) (kube_resourcequota{resource=\"requests.cpu\", type=\"used\", namespace=~\"$namespace\"})",
            "instant": true
          },
          {
            "refId": "cpu_hard",
            "expr": "sum by (namespace) (kube_resourcequota{resource=\"requests.cpu\", type=\"hard\", namespace=~\"$namespace\"})",
            "instant": true
          },
          {
            "refId": "mem_used",
            "expr": "sum by (namespace) (kube_resourcequota{resource=\"requests.memory\", type=\"used\", namespace=~\"$namespace\"}) / 1024^3",
            "instant": true
          },
          {
            "refId": "mem_hard",
            "expr": "sum by (namespace) (kube_resourcequota{resource=\"requests.memory\", type=\"hard\", namespace=~\"$namespace\"}) / 1024^3",
            "instant": true
          }
        ]
      },
      {
        "type": "row",
        "title": "Network",
        "gridPos": {
          "h": 1,
          "w": 24,
          "x": 0,
          "y": 32
        },
        "collapsed": true,
        "panels": []
      },
      {
        "type": "bargauge",
        "title": "Namespace Ingress (KiB/s)",
        "gridPos": {
          "h": 7,
          "w": 12,
          "x": 0,
          "y": 33
        },
        "datasource": "${DS}",
        "targets": [
          {
            "refId": "A",
            "expr": "sum by (namespace) (rate(container_network_receive_bytes_total{namespace=~\"$namespace\"}[$__rate_interval])) / 1024",
            "instant": true,
            "legendFormat": "{{namespace}}"
          }
        ]
      },
      {
        "type": "bargauge",
        "title": "Namespace Egress (KiB/s)",
        "gridPos": {
          "h": 7,
          "w": 12,
          "x": 12,
          "y": 33
        },
        "datasource": "${DS}",
        "targets": [
          {
            "refId": "A",
            "expr": "sum by (namespace) (rate(container_network_transmit_bytes_total{namespace=~\"$namespace\"}[$__rate_interval])) / 1024",
            "instant": true,
            "legendFormat": "{{namespace}}"
          }
        ]
      },
      {
        "type": "row",
        "title": "Top Namespaces",
        "gridPos": {
          "h": 1,
          "w": 24,
          "x": 0,
          "y": 40
        },
        "collapsed": false,
        "panels": []
      },
      {
        "type": "bargauge",
        "title": "Top 5 Namespaces by CPU (cores)",
        "gridPos": {
          "h": 7,
          "w": 12,
          "x": 0,
          "y": 41
        },
        "datasource": "${DS}",
        "targets": [
          {
            "refId": "A",
            "expr": "topk(5, sum by (namespace) (sum by (namespace,pod) (rate(container_cpu_usage_seconds_total{image!=\"\"}[$__rate_interval]))))",
            "instant": true,
            "legendFormat": "{{namespace}}"
          }
        ]
      },
      {
        "type": "bargauge",
        "title": "Top 5 Namespaces by Memory (GiB)",
        "gridPos": {
          "h": 7,
          "w": 12,
          "x": 12,
          "y": 41
        },
        "datasource": "${DS}",
        "targets": [
          {
            "refId": "A",
            "expr": "topk(5, sum by (namespace) (sum by (namespace,pod) (container_memory_working_set_bytes{container!=\"\"})) / 1024^3)",
            "instant": true,
            "legendFormat": "{{namespace}}"
          }
        ]
      }
    ]
  }
}
