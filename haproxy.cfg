frontend web_frontend
    bind *:80
    bind *:443 ssl crt /path/to/cert.pem
    
    acl is_cellphone_product path_reg ^/business/cell-phone/[a-zA-Z0-9\-]+/?(\?.*)?$
    acl has_sku_param url_param(sku) -m found
    acl valid_sku_format url_param(sku) -m reg ^[0-9]{12}$
    
    # For invalid format, redirect immediately
    redirect location https://www.t-mobile.com/business/cell-phone/ code 302 if is_cellphone_product has_sku_param !valid_sku_format
    
    # For valid format but potentially invalid SKU, let backend handle with fallback
    http-request set-header X-Original-URI %[capture.req.uri] if is_cellphone_product has_sku_param valid_sku_format
    
    default_backend web_servers

backend web_servers
    # Backend can check SKU validity and return 404, which HAProxy can catch
    option httpchk GET /health
    
    # Error handling for invalid SKUs returned by backend
    errorfile 404 /etc/haproxy/errors/404.http
    
    server web1 pod1:8080 check
    server web2 pod2:8080 check
