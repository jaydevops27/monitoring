variables:
  PREENV: "dev"

Monitor-B07:
  stage: monitor
  image: python:3.9
  variables:
    PREENV: "dev"
  before_script:
    # Install required system packages
    - apt-get update && apt-get install -y curl openssh-client sshpass coreutils gettext-base
    # Install Python packages
    - pip install kubernetes requests tabulate reportlab
  script:
    - |
      if [ $PREENV = dev ]
      then
        # Download and install kubectl
        KUBECTL_VERSION=$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)
        curl -LO "https://storage.googleapis.com/kubernetes-release/release/${KUBECTL_VERSION}/bin/linux/amd64/kubectl"
        chmod +x ./kubectl
        mv ./kubectl /usr/local/bin/kubectl
        
        # Set the KUBECONFIG environment variable to your existing config
        export KUBECONFIG=$PWD/B07config-west
        
        # Verify kubectl can connect (optional)
        kubectl cluster-info || echo "Warning: kubectl connection failed"
        
        echo "==========================Listing B07 Monitor=========================="
        
        python k8s_health_check.py b07-prd-tfp-prd-w2 --output-format html --output-dir reports
      else
        echo $USERNAME
      fi
  tags:
    - west-2
  artifacts:
    reports:
      junit: reports/junit.xml
    paths:
      - reports/
    expire_in: 1 week
    when: always
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
    - if: '$CI_COMMIT_BRANCH == "main"'
    when: manual
